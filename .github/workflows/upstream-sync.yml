name: Sync Upstream

on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for upstream changes
        id: check_upstream
        run: |
          # Fetch latest upstream commit hash
          LATEST_UPSTREAM=$(git ls-remote https://github.com/developerfromjokela/opencarwings.git HEAD | cut -f1)

          # Get last synced commit
          if [ -f "opencarwings/.upstream_sync" ]; then
            LAST_SYNC=$(cat opencarwings/.upstream_sync)
          else
            LAST_SYNC=""
          fi

          if [ "$LAST_SYNC" = "$LATEST_UPSTREAM" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No new upstream changes"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "last_sync=$LAST_SYNC" >> $GITHUB_OUTPUT
            echo "latest_upstream=$LATEST_UPSTREAM" >> $GITHUB_OUTPUT
            echo "New upstream changes detected"
            echo "Last sync: $LAST_SYNC"
            echo "Latest upstream: $LATEST_UPSTREAM"
          fi

      - name: Get upstream changelog
        if: steps.check_upstream.outputs.has_changes == 'true'
        id: upstream_log
        run: |
          LAST_SYNC="${{ steps.check_upstream.outputs.last_sync }}"

          # Clone upstream to get commit history
          git clone --bare https://github.com/developerfromjokela/opencarwings.git temp_upstream
          cd temp_upstream

          if [ -z "$LAST_SYNC" ]; then
            # First sync - get last 10 commits
            git log --pretty=format:"- %s (%h)" -10 > ../upstream_commits.txt
          else
            # Get commits since last sync
            git log --pretty=format:"- %s (%h)" ${LAST_SYNC}..HEAD > ../upstream_commits.txt || {
              echo "Could not get commit range, getting last 10 commits instead"
              git log --pretty=format:"- %s (%h)" -10 > ../upstream_commits.txt
            }
          fi

          cd ..
          rm -rf temp_upstream

      - name: Get current version
        if: steps.check_upstream.outputs.has_changes == 'true'
        id: current_version
        run: |
          if grep -q '^version:' opencarwings/config.yaml; then
            VERSION=$(grep '^version:' opencarwings/config.yaml | sed 's/version: "\(.*\)"/\1/')
          else
            VERSION="0.0.0"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $VERSION"

      - name: Bump base version
        if: steps.check_upstream.outputs.has_changes == 'true'
        id: bump_version
        run: |
          CURRENT="${{ steps.current_version.outputs.version }}"

          # Strip addon patch if it exists (0.0.2-3 -> 0.0.2)
          if [[ "$CURRENT" =~ ^([0-9]+\.[0-9]+\.[0-9]+)-([0-9]+)$ ]]; then
            BASE="${BASH_REMATCH[1]}"
          elif [[ "$CURRENT" =~ ^([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
            BASE="$CURRENT"
          else
            BASE="0.0.0"
          fi

          # Bump patch of base version
          IFS='.' read -r major minor patch <<< "$BASE"
          NEW_VERSION="${major}.${minor}.$((patch + 1))"

          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New upstream version: $NEW_VERSION"

      - name: Update changelog
        if: steps.check_upstream.outputs.has_changes == 'true'
        run: |
          NEW_VERSION="${{ steps.bump_version.outputs.new_version }}"

          {
            echo "## v${NEW_VERSION} - $(date +%Y-%m-%d) [Upstream Update]"
            echo ""
            echo "Synced with latest upstream changes from opencarwings repository."
            echo ""
            cat upstream_commits.txt
            echo ""
            echo ""
          } > new_changes.md

          if [ -f "opencarwings/CHANGELOG.md" ]; then
            cat new_changes.md opencarwings/CHANGELOG.md > temp.md
            mv temp.md opencarwings/CHANGELOG.md
          else
            echo "# Changelog" > opencarwings/CHANGELOG.md
            echo "" >> opencarwings/CHANGELOG.md
            cat new_changes.md >> opencarwings/CHANGELOG.md
          fi

      - name: Update version in config.yaml
        if: steps.check_upstream.outputs.has_changes == 'true'
        run: |
          NEW_VERSION="${{ steps.bump_version.outputs.new_version }}"
          sed -i "s/^version: .*/version: \"$NEW_VERSION\"/" opencarwings/config.yaml

      - name: Update sync marker
        if: steps.check_upstream.outputs.has_changes == 'true'
        run: |
          LATEST_UPSTREAM="${{ steps.check_upstream.outputs.latest_upstream }}"
          echo "$LATEST_UPSTREAM" > opencarwings/.upstream_sync

      - name: Commit and push
        if: steps.check_upstream.outputs.has_changes == 'true'
        run: |
          NEW_VERSION="${{ steps.bump_version.outputs.new_version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add opencarwings/config.yaml opencarwings/CHANGELOG.md opencarwings/.upstream_sync
          git commit -m "Upstream sync - v${NEW_VERSION}"
          git tag "v${NEW_VERSION}"
          git push origin main
          git push origin "v${NEW_VERSION}"
