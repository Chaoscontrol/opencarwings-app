name: Sync Upstream

on:
  schedule:
    - cron: "0 3 * * *" # Runs at 3 AM UTC (after version bump)
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/developerfromjokela/opencarwings.git || true
          git fetch upstream main

      - name: Check for upstream changes
        id: check_upstream
        run: |
          # Get the last commit we synced (stored in a marker file)
          if [ -f ".upstream_sync" ]; then
            LAST_SYNC=$(cat .upstream_sync)
          else
            LAST_SYNC=""
          fi

          # Get latest upstream commit
          LATEST_UPSTREAM=$(git rev-parse upstream/main)

          if [ "$LAST_SYNC" = "$LATEST_UPSTREAM" ]; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No new upstream changes"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "last_sync=$LAST_SYNC" >> $GITHUB_OUTPUT
            echo "latest_upstream=$LATEST_UPSTREAM" >> $GITHUB_OUTPUT
            echo "New upstream changes detected"
          fi

      - name: Generate upstream changelog
        if: steps.check_upstream.outputs.has_changes == 'true'
        run: |
          LAST_SYNC="${{ steps.check_upstream.outputs.last_sync }}"

          {
            echo "### Upstream changes synced on $(date +%Y-%m-%d)"
            echo ""
            if [ -z "$LAST_SYNC" ]; then
              echo "Initial sync with upstream repository"
              git log upstream/main --pretty=format:"- %s (%h)" -20  # Last 20 commits
            else
              git log ${LAST_SYNC}..upstream/main --pretty=format:"- %s (%h)"
            fi
            echo ""
            echo ""
          } > upstream_changes.md

          # Append to CHANGELOG.md
          if [ -f "opencarwings/CHANGELOG.md" ]; then
            # Insert after the first version header
            sed -i '/^## v/r upstream_changes.md' opencarwings/CHANGELOG.md
          else
            echo "# Changelog" > opencarwings/CHANGELOG.md
            echo "" >> opencarwings/CHANGELOG.md
            cat upstream_changes.md >> opencarwings/CHANGELOG.md
          fi

      - name: Merge upstream changes
        if: steps.check_upstream.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Try to merge upstream/main
          if git merge upstream/main --no-edit -m "Sync with upstream"; then
            echo "Merge successful"
          else
            echo "Merge conflict detected - manual resolution required"
            git merge --abort
            exit 1
          fi

      - name: Update sync marker
        if: steps.check_upstream.outputs.has_changes == 'true'
        run: |
          LATEST_UPSTREAM="${{ steps.check_upstream.outputs.latest_upstream }}"
          echo "$LATEST_UPSTREAM" > .upstream_sync
          git add .upstream_sync

      - name: Commit and push
        if: steps.check_upstream.outputs.has_changes == 'true'
        run: |
          git add opencarwings/CHANGELOG.md
          git commit --amend --no-edit
          git push origin main

      - name: Create issue on merge conflict
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '⚠️ Upstream sync failed - merge conflict',
              body: 'The automated upstream sync encountered a merge conflict and requires manual resolution.\n\nPlease manually sync with upstream:\n```bash\ngit remote add upstream https://github.com/developerfromjokela/opencarwings.git\ngit fetch upstream\ngit merge upstream/main\n# Resolve conflicts\ngit push\n```',
              labels: ['upstream-sync', 'needs-attention']
            })
