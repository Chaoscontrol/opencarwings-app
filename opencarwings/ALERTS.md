# OpenCarwings Alert System & Status Codes

This document outlines the internal Alert Types and Vehicle Result States used by the OpenCarwings `tcuserver.py` component to classify vehicle events.

**Source Information:**
- **Source File**: `tculink/management/commands/tcuserver.py`
- **Repository**: [developerfromjokela/opencarwings](https://github.com/developerfromjokela/opencarwings)
- **Patch Location**: `etc/cont-init.d/05-patch-settings.sh` (Patch 5)

---

## 1. Alert Types (Internal IDs)

These are the numerical IDs used by the `AlertHistory` model to log events in the database.

| Type ID | Description | Source Trigger (Packet Type) |
| :--- | :--- | :--- |
| **1** | Charge Finished | `remote_stop` (if `alertstate` is 4 or 68) |
| **2** | Charge Started | `charge_result` (default) |
| **3** | Cable Reminder / Unplugged | `cp_remind` OR `charge_result` (if `resultstate` is 17) |
| **4** | A/C Started | `ac_result` (if `resultstate` is 64) |
| **5** | A/C Stopped | `ac_result` (if `resultstate` is 32) |
| **6** | TCU Config Received | Message Type 5 (Config Sync) |
| **7** | A/C Auto-Off / Finished | `ac_result` (if `resultstate` is 192) OR `remote_stop` default |
| **8** | Quick Charge Finished | `remote_stop` (if `alertstate` is 8) |
| **9** | Battery Heater ON | `battery_heat` (if active) |
| **10** | Battery Heater OFF | `battery_heat` (if inactive) |
| **96** | Charge Error | (Unused/Reserved for future logic) |
| **97** | A/C Error | `ac_result` (if `resultstate` is unknown) |
| **99** | System Error | Authentication Failure, ID Mismatch, Invalid Packet |

---

## 2. Vehicle Result States (Raw Protocol)

These are the raw hexadecimal/decimal values returned by the TCU (Telematics Control Unit) in specific response packets.

### Charge Result (`charge_result`)
Sent by the car after receiving a "Start Charge" command.

| ResultState | Hex | Meaning | Alert Type |
| :--- | :--- | :--- | :--- |
| **Any** | - | Charge Command Accepted | 2 (Default) |
| **17** | `0x11` | **Vehicle Unplugged** (Charge failed) | 3 (Patched) |

### A/C Result (`ac_result`)
Sent by the car after receiving an A/C command.

| ResultState | Hex | Meaning | Alert Type |
| :--- | :--- | :--- | :--- |
| **64** | `0x40` | A/C Started Successfully | 4 |
| **32** | `0x20` | A/C Stopped Successfully | 5 |
| **192** | `0xC0` | A/C Finished / Auto-Off | 7 |
| **Others** | - | A/C Operation Failed | 97 |

### Remote Stop (`remote_stop`)
Sent by the car when an operation stops (A/C or Charging). The system uses `alertstate` to differentiate.

| AlertState | Hex | Meaning | Alert Type |
| :--- | :--- | :--- | :--- |
| **4** | `0x04` | Normal Charge Complete | 1 |
| **68** | `0x44` | Normal Charge Complete | 1 |
| **8** | `0x08` | Quick Charge Complete | 8 |
| **Others** | - | A/C Operation Complete | 7 |

---

## 3. Special Error States (Type 99)

These are generated by the server logic itself when validation fails:

- **TCU ID Mismatch**: The TCU ID reported by the car does not match the database record.
- **Navi ID Mismatch**: The Navigation Unit ID does not match.
- **SIM ID (ICCID) Mismatch**: The SIM card ID does not match.
- **Authentication Failed**: Username/Password provided by the car (in GDC packet) is incorrect or missing.

## Sources & References

The values documented above were derived from two primary sources:

1.  **Upstream Source Code**: The original handling logic is defined in `tcuserver.py` from the OpenCarwings repository.
    *   **File**: [`tcuserver.py`](https://github.com/developerfromjokela/opencarwings/blob/main/tculink/management/commands/tcuserver.py)
    *   **Relevant Lines**: The `handle_client` method (specifically around the `parse_gdc_packet` logic) defines how `resultstate` and `alertstate` are mapped to internal Alert IDs.
        *   `ac_result`: Maps states 64 (0x40), 32 (0x20), and 192 to A/C alerts.
        *   `remote_stop`: Maps states 4, 68 (0x44), and 8 to Charge Finish alerts.
        *   `charge_result`: Originally hardcoded to Alert Type 2.

2.  **Local Patches**: We have modified this logic in our specific deployment to handle the "Unplugged" state correctly.
    *   **File**: `rootfs/etc/cont-init.d/05-patch-settings.sh`
    *   **Modification**: We inject logic to check for `resultstate == 17` (0x11) in `charge_result` packets, mapping it to "Cable Reminder" instead of "Charge Start".
